<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Famelo v8 | AI Image Ingestion Pro</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:         #07080d;
  --surface:    #0d0f18;
  --card:       #111420;
  --card2:      #161a27;
  --card3:      #1c2133;
  --border:     rgba(255,255,255,0.06);
  --border2:    rgba(255,255,255,0.10);
  --glow:       #5b4af8;
  --glow2:      #9d4af8;
  --cyan:       #22d3ee;
  --green:      #10e89a;
  --amber:      #f59e0b;
  --red:        #ff4d6d;
  --text:       #e8eaf2;
  --text2:      #8891ab;
  --text3:      #4a5270;
  --free-badge: #0d3320;
  --free-text:  #10e89a;
  --paid-badge: #2d1a00;
  --paid-text:  #f59e0b;
  --sb-w:       390px;
  --r:          14px;
  --r-sm:       8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{font-size:16px;}

/* â”€â”€ SCROLLBARS â”€â”€ */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--card3);border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:var(--glow);}

body{
  font-family:'IBM Plex Sans Arabic',system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
  overflow:hidden;
  position:relative;
}

/* mesh background */
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 70% 50% at 15% 60%, rgba(91,74,248,.12) 0%, transparent 60%),
    radial-gradient(ellipse 50% 40% at 85% 20%, rgba(157,74,248,.08) 0%, transparent 60%),
    radial-gradient(ellipse 40% 30% at 80% 80%, rgba(34,211,238,.06) 0%, transparent 50%);
  animation:meshShift 25s ease-in-out infinite alternate;
}
@keyframes meshShift{from{transform:translate(0,0)}to{transform:translate(15px,10px)}}

/* grain overlay */
body::after{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  opacity:.025;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{
  width:var(--sb-w);min-width:var(--sb-w);
  background:var(--surface);
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;
  z-index:100;
  box-shadow:8px 0 40px rgba(0,0,0,.6);
  position:relative;
}

.sb-head{
  padding:20px 22px 16px;
  background:linear-gradient(145deg,rgba(91,74,248,.2),rgba(157,74,248,.1));
  border-bottom:1px solid var(--border);
  position:relative;overflow:hidden;
  flex-shrink:0;
}
.sb-head::before{
  content:'';position:absolute;inset:-50%;
  background:conic-gradient(from 0deg at 30% 50%,transparent 0%,rgba(91,74,248,.08) 30%,transparent 60%);
  animation:spin 20s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.sb-logo{
  display:flex;align-items:center;gap:10px;
  position:relative;z-index:1;
}
.sb-logo-icon{
  width:38px;height:38px;border-radius:10px;
  background:linear-gradient(135deg,var(--glow),var(--glow2));
  display:flex;align-items:center;justify-content:center;
  font-size:17px;color:#fff;
  box-shadow:0 4px 16px rgba(91,74,248,.4);
}
.sb-logo-text h1{font-size:.95rem;font-weight:700;letter-spacing:-.3px;}
.sb-logo-text p{font-size:.68rem;color:var(--text2);margin-top:1px;font-weight:400;}

.sb-body{flex:1;overflow-y:auto;padding:18px 16px;}

/* section label */
.sec-label{
  font-size:.63rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--text3);margin:20px 0 10px;
  display:flex;align-items:center;gap:6px;
}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* provider selector */
.provider-select-wrap{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r-sm);overflow:hidden;
  display:grid;grid-template-columns:1fr 1fr;gap:1px;
  background-color:var(--border);
  margin-bottom:12px;
}
.prov-btn{
  background:var(--card);border:none;padding:9px 6px;
  cursor:pointer;font-family:inherit;font-size:.7rem;font-weight:600;
  color:var(--text2);display:flex;flex-direction:column;align-items:center;gap:3px;
  transition:background .2s,color .2s;
}
.prov-btn .pb-icon{font-size:1.1rem;}
.prov-btn .pb-name{font-size:.62rem;white-space:nowrap;}
.prov-btn .pb-badge{
  font-size:.52rem;padding:1px 5px;border-radius:3px;font-weight:700;
  margin-top:1px;letter-spacing:.3px;text-transform:uppercase;
}
.prov-btn .free-b{background:var(--free-badge);color:var(--free-text);}
.prov-btn .paid-b{background:var(--paid-badge);color:var(--paid-text);}
.prov-btn.active{background:linear-gradient(135deg,rgba(91,74,248,.25),rgba(157,74,248,.15));color:#fff;}
.prov-btn:hover:not(.active){background:var(--card2);}

/* provider panels */
.prov-panel{display:none;animation:fadeIn .2s ease;}
.prov-panel.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* field */
.field{margin-bottom:10px;}
.field label{
  display:block;font-size:.73rem;font-weight:600;
  color:var(--text2);margin-bottom:5px;
}
.key-wrap{position:relative;}
.key-wrap input{padding-left: 38px !important;}
.key-eye{
  position:absolute;left:10px;top:50%;transform:translateY(-50%);
  background:none;border:none;color:var(--text3);cursor:pointer;
  padding:4px;font-size:.85rem;
  transition:color .2s;
}
.key-eye:hover{color:var(--text);}
.key-saved{
  position:absolute;right:8px;top:50%;transform:translateY(-50%);
  width:6px;height:6px;border-radius:50%;background:var(--green);
  box-shadow:0 0 6px var(--green);display:none;
}
.key-wrap.saved .key-saved{display:block;}

input[type=text],input[type=password],input[type=number],select,textarea{
  width:100%;padding:9px 12px;
  background:var(--card2);border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);
  font-family:inherit;font-size:.8rem;
  transition:border .2s,box-shadow .2s;outline:none;
  -webkit-appearance:none;
}
input:focus,select:focus,textarea:focus{
  border-color:rgba(91,74,248,.6);
  box-shadow:0 0 0 3px rgba(91,74,248,.12);
}
select option{background:var(--card2);}
.field small{font-size:.65rem;color:var(--text3);margin-top:4px;display:block;line-height:1.4;}
.field small a{color:var(--cyan);text-decoration:none;}
.field small a:hover{text-decoration:underline;}

/* template mode tabs */
.tpl-tabs{display:flex;gap:2px;background:var(--card2);padding:3px;border-radius:var(--r-sm);margin-bottom:10px;}
.tpl-tab{
  flex:1;padding:7px;text-align:center;font-size:.72rem;font-weight:600;
  border:none;border-radius:6px;cursor:pointer;font-family:inherit;
  color:var(--text2);background:transparent;transition:all .2s;
}
.tpl-tab.active{background:linear-gradient(135deg,var(--glow),var(--glow2));color:#fff;box-shadow:0 2px 8px rgba(91,74,248,.3);}

/* CSV drop zone */
.csv-drop{
  border:1.5px dashed var(--border2);border-radius:var(--r-sm);
  padding:18px;text-align:center;cursor:pointer;
  transition:all .2s;color:var(--text3);font-size:.78rem;
}
.csv-drop:hover{border-color:var(--cyan);color:var(--cyan);}
.csv-drop.loaded{border-color:var(--green);color:var(--green);}
.csv-drop i{font-size:1.8rem;display:block;margin-bottom:6px;}
.csv-cols{
  display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;
}
.csv-col-tag{
  font-size:.62rem;padding:2px 7px;border-radius:4px;
  background:rgba(34,211,238,.08);color:var(--cyan);
  border:1px solid rgba(34,211,238,.2);font-weight:600;
}
.csv-sample{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:8px;margin-top:8px;
  font-family:'JetBrains Mono',monospace;font-size:.62rem;
  color:var(--text2);max-height:90px;overflow-y:auto;white-space:pre;
  display:none;
}
.csv-sample.show{display:block;}

.sb-foot{
  padding:14px 16px;
  border-top:1px solid var(--border);
  background:var(--surface);
  flex-shrink:0;
}

/* menu toggle for mobile */
.menu-toggle{
  display:none;position:fixed;bottom:20px;left:20px;z-index:200;
  width:52px;height:52px;border-radius:50%;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--glow),var(--glow2));
  color:#fff;font-size:1.2rem;
  box-shadow:0 6px 24px rgba(91,74,248,.5);
  align-items:center;justify-content:center;
}
.overlay-bg{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);
  z-index:99;backdrop-filter:blur(6px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{
  flex:1;overflow-y:auto;
  padding:24px;
  display:flex;flex-direction:column;gap:16px;
  position:relative;z-index:1;
}

/* â”€â”€ STAT HEADER â”€â”€ */
.stat-header{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r);padding:20px 22px;
}
.stat-top{
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:10px;margin-bottom:16px;
}
.stat-title{font-size:1.05rem;font-weight:700;display:flex;align-items:center;gap:8px;}
.provider-pill{
  display:flex;align-items:center;gap:6px;
  padding:5px 12px;border-radius:20px;font-size:.72rem;font-weight:600;
  background:var(--card2);border:1px solid var(--border);color:var(--text2);
  transition:all .3s;
}
.provider-pill.active{
  background:rgba(91,74,248,.15);border-color:rgba(91,74,248,.4);
  color:var(--glow);
}
.provider-pill .pulse{
  width:6px;height:6px;border-radius:50%;background:var(--text3);
}
.provider-pill.active .pulse{
  background:var(--glow);
  box-shadow:0 0 0 0 rgba(91,74,248,.6);
  animation:pulseRing 1.5s ease-out infinite;
}
@keyframes pulseRing{
  0%{box-shadow:0 0 0 0 rgba(91,74,248,.6)}
  100%{box-shadow:0 0 0 8px rgba(91,74,248,0)}
}

.stats-grid{
  display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
  margin-bottom:14px;
}
.sbox{
  background:var(--card2);border:1px solid var(--border);
  border-radius:10px;padding:12px;text-align:center;
  position:relative;overflow:hidden;
}
.sbox::before{
  content:'';position:absolute;top:0;inset-inline:0;height:2px;
  background:currentColor;opacity:.5;
}
.sbox .slbl{font-size:.6rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;}
.sbox .sval{font-size:2rem;font-weight:800;margin-top:4px;line-height:1;font-family:'JetBrains Mono',monospace;}
.sbox.s-info{color:var(--cyan);}
.sbox.s-ok{color:var(--green);}
.sbox.s-warn{color:var(--amber);}
.sbox.s-err{color:var(--red);}

.pbar-track{
  height:6px;background:var(--card2);border-radius:3px;overflow:hidden;
  border:1px solid var(--border);
}
.pbar-fill{
  height:100%;
  background:linear-gradient(90deg,var(--glow),var(--glow2),var(--cyan));
  background-size:200%;
  width:0%;
  transition:width .4s ease;
  animation:barShimmer 3s linear infinite;
}
@keyframes barShimmer{0%{background-position:100%}100%{background-position:-100%}}
.pbar-meta{
  display:flex;justify-content:space-between;margin-top:6px;
  font-size:.72rem;color:var(--text3);font-weight:600;
  font-family:'JetBrains Mono',monospace;
}

.cur-task{
  display:none;align-items:center;gap:8px;
  margin-top:12px;padding:10px 14px;
  background:rgba(245,158,11,.06);border-radius:var(--r-sm);
  border-right:3px solid var(--amber);font-size:.78rem;color:var(--amber);
}

.ctrl-btns{display:flex;gap:8px;margin-top:12px;}
.ctrl-btns .btn{flex:1;}

/* â”€â”€ DROP ZONE â”€â”€ */
.drop-zone{
  border:1.5px dashed var(--border2);border-radius:var(--r);
  padding:48px 24px;text-align:center;cursor:pointer;
  background:var(--card);
  transition:all .25s;position:relative;overflow:hidden;
}
.drop-zone::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(circle at 50% 100%,rgba(91,74,248,.08),transparent 70%);
  pointer-events:none;
}
.drop-zone:hover,.drop-zone.dragover{
  border-color:var(--glow);
  background:linear-gradient(135deg,rgba(91,74,248,.06),rgba(157,74,248,.04));
  transform:translateY(-2px);
  box-shadow:0 12px 40px rgba(91,74,248,.15);
}
.dz-icon{
  font-size:2.8rem;
  background:linear-gradient(135deg,var(--glow),var(--glow2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  animation:float 3s ease-in-out infinite;display:block;margin-bottom:12px;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.dz-title{font-size:.95rem;font-weight:700;margin-bottom:4px;}
.dz-sub{font-size:.75rem;color:var(--text3);}

/* â”€â”€ IMAGE GRID â”€â”€ */
.img-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(165px,1fr));
  gap:12px;
}
.img-card{
  position:relative;border-radius:var(--r-sm);overflow:hidden;
  height:190px;cursor:pointer;
  border:1.5px solid var(--border);
  background:var(--card);
  transition:transform .2s,box-shadow .2s,border-color .25s;
}
.img-card img{width:100%;height:100%;object-fit:cover;display:block;}
.img-card:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(0,0,0,.5);}
.img-card.done{border-color:rgba(16,232,154,.5);}
.img-card.error{border-color:rgba(255,77,109,.5);}
.img-card.processing{
  border-color:rgba(245,158,11,.5);
  animation:cardPulse 2s ease-in-out infinite;
}
.img-card.paused{border-color:rgba(34,211,238,.4);opacity:.6;}
@keyframes cardPulse{
  0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}
  50%{box-shadow:0 0 0 6px rgba(245,158,11,.15)}
}

.card-overlay{
  position:absolute;inset:0;background:rgba(7,8,13,.92);
  display:none;flex-direction:column;align-items:center;justify-content:center;
  backdrop-filter:blur(4px);
}
.ring{transform:rotate(-90deg);}
.ring-circle{transition:stroke-dashoffset .25s linear;}
.pct-txt{font-size:14px;font-weight:700;margin-top:8px;font-family:'JetBrains Mono',monospace;}
.card-status-badge{
  font-size:9px;margin-top:6px;
  background:rgba(255,255,255,.12);padding:3px 10px;
  border-radius:6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;
}
.card-sub{font-size:8px;margin-top:4px;color:var(--text2);}

/* â”€â”€ EXPORT PANEL â”€â”€ */
.export-panel{
  display:none;background:var(--card);
  border:1px solid rgba(16,232,154,.25);border-radius:var(--r);
  padding:20px 22px;
  box-shadow:0 0 40px rgba(16,232,154,.06);
}
.export-panel.show{display:block;}
.export-panel-head{
  display:flex;align-items:center;gap:8px;
  font-size:.95rem;font-weight:700;color:var(--green);
  margin-bottom:14px;
}
.export-row{display:flex;gap:10px;flex-wrap:wrap;}
.export-row .field{flex:1;min-width:140px;}

/* â”€â”€ LOGS â”€â”€ */
.logs-panel{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r);padding:16px 18px;
}
.logs-head{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;flex-wrap:wrap;gap:8px;
}
.logs-head-left{
  display:flex;align-items:center;gap:7px;
  font-size:.82rem;font-weight:700;
}
.logs-btns{display:flex;gap:6px;}
.log-btn{
  background:var(--card2);border:1px solid var(--border);
  color:var(--text2);padding:5px 10px;border-radius:6px;
  cursor:pointer;font-size:.68rem;font-weight:600;
  display:flex;align-items:center;gap:4px;font-family:inherit;
  transition:all .2s;
}
.log-btn:hover{background:var(--glow);color:#fff;border-color:var(--glow);}

#log-area{
  background:#020407;border:1px solid rgba(255,255,255,.04);
  border-radius:8px;height:150px;overflow-y:auto;
  padding:10px;font-family:'JetBrains Mono',monospace;
  font-size:.68rem;line-height:1.7;color:var(--green);
}
.log-row{display:flex;gap:6px;align-items:flex-start;animation:logIn .2s ease;}
@keyframes logIn{from{opacity:0;transform:translateX(4px)}to{opacity:1;transform:translateX(0)}}
.log-ts{color:var(--text3);white-space:nowrap;flex-shrink:0;}
.log-ic{flex-shrink:0;width:13px;}
.log-msg{word-break:break-all;}
.log-error .log-msg{color:#ff4d6d;} .log-warning .log-msg{color:#f59e0b;}
.log-info .log-msg{color:#60a5fa;} .log-sys .log-msg{color:#a78bfa;}
.log-success .log-msg{color:var(--green);}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  width:100%;padding:11px 16px;border:none;border-radius:10px;
  font-weight:700;cursor:pointer;display:flex;align-items:center;
  justify-content:center;gap:8px;color:#fff;font-size:.8rem;
  font-family:inherit;letter-spacing:.2px;position:relative;overflow:hidden;
  transition:transform .15s,box-shadow .2s,filter .2s;
}
.btn:disabled{background:#1c2133 !important;cursor:not-allowed;opacity:.5;box-shadow:none !important;}
.btn:not(:disabled):hover{transform:translateY(-2px);filter:brightness(1.1);}
.btn:not(:disabled):active{transform:translateY(0);}
.btn-primary{background:linear-gradient(135deg,var(--glow),var(--glow2));box-shadow:0 4px 20px rgba(91,74,248,.35); margin-bottom: 24px;}
.btn-success{background:linear-gradient(135deg,#059669,#10b981);box-shadow:0 4px 20px rgba(16,185,129,.3);}
.btn-warning{background:linear-gradient(135deg,#d97706,#f59e0b);box-shadow:0 4px 20px rgba(245,158,11,.3);}
.btn-danger{background:linear-gradient(135deg,#dc2626,#ef4444);box-shadow:0 4px 20px rgba(239,68,68,.3);}
.btn-ghost{background:var(--card2);border:1px solid var(--border);color:var(--text2);box-shadow:none;}
.btn-ghost:hover{background:var(--card3);border-color:var(--glow);color:var(--text) !important;}
.btn-sm{padding:8px 14px;font-size:.72rem;width:auto;border-radius:8px;}

/* â”€â”€ MODAL â”€â”€ */
.modal{
  display:none;position:fixed;inset:0;z-index:300;
  align-items:center;justify-content:center;padding:20px;
  background:rgba(0,0,0,.85);backdrop-filter:blur(8px);
}
.modal-box{
  background:var(--card);border:1px solid var(--border2);
  border-radius:16px;width:100%;max-width:680px;max-height:90vh;
  display:flex;flex-direction:column;
  box-shadow:0 24px 80px rgba(0,0,0,.8);
  animation:modalIn .25s cubic-bezier(.34,1.56,.64,1);
}
@keyframes modalIn{from{transform:scale(.92)translateY(20px);opacity:0}to{transform:scale(1)translateY(0);opacity:1}}
.modal-head{
  padding:16px 22px;background:linear-gradient(135deg,rgba(91,74,248,.2),rgba(157,74,248,.1));
  border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;
  border-radius:16px 16px 0 0;
}
.modal-head h3{font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:7px;}
.modal-close{
  background:rgba(255,255,255,.08);border:none;color:var(--text2);
  width:30px;height:30px;border-radius:7px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1rem;
  transition:all .2s;
}
.modal-close:hover{background:var(--red);color:#fff;}
.modal-body{padding:20px;overflow-y:auto;flex:1;}

/* â”€â”€ NOTIFICATIONS â”€â”€ */
.notif-container{
  position:fixed;top:18px;left:18px;z-index:400;
  display:flex;flex-direction:column;gap:8px;max-width:360px;
}
.notif{
  background:var(--card2);border:1px solid var(--border2);
  border-radius:12px;padding:12px 14px;
  display:flex;align-items:center;gap:10px;
  box-shadow:0 8px 30px rgba(0,0,0,.6);
  animation:notifIn .3s cubic-bezier(.34,1.56,.64,1);
  border-right:3px solid currentColor;
}
.notif.success{color:var(--green);}
.notif.error{color:var(--red);}
.notif.warning{color:var(--amber);}
.notif.info{color:var(--cyan);}
.notif i{font-size:1.1rem;flex-shrink:0;}
.notif-content{flex:1;}
.notif-title{font-size:.82rem;font-weight:700;color:var(--text);}
.notif-msg{font-size:.72rem;color:var(--text2);margin-top:2px;}
.notif-close{
  background:none;border:none;color:var(--text3);cursor:pointer;
  width:22px;height:22px;border-radius:5px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;font-size:.9rem;
  transition:all .2s;
}
.notif-close:hover{background:rgba(255,77,109,.15);color:var(--red);}
@keyframes notifIn{from{transform:translateX(-110%);opacity:0}to{transform:translateX(0);opacity:1}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:1100px){:root{--sb-w:350px;}}
@media(max-width:860px){
  .sidebar{
    position:fixed;right:-110%;top:0;height:100%;
    transition:right .3s cubic-bezier(.4,0,.2,1);
  }
  .sidebar.open{right:0;}
  .overlay-bg.open{display:block;}
  .menu-toggle{display:flex;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:640px){
  .main{padding:14px;gap:12px;}
  .stat-header{padding:14px 16px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:8px;}
  .sbox .sval{font-size:1.6rem;}
  .drop-zone{padding:32px 16px;}
  .img-grid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:9px;}
  .img-card{height:155px;}
  .export-row{flex-direction:column;}
  .ctrl-btns{flex-direction:column;}
  .provider-select-wrap{grid-template-columns:1fr 1fr 1fr;}
}
@media(max-width:420px){
  .provider-select-wrap{grid-template-columns:1fr 1fr;}
  .main{padding:10px;gap:10px;}
}
</style>
</head>
<body>

<div class="notif-container" id="notifContainer"></div>
<button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-sliders-h"></i></button>
<div class="overlay-bg" onclick="toggleSidebar()"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar" id="sidebar">
  <div class="sb-head">
    <div class="sb-logo">
      <div class="sb-logo-icon"><i class="fas fa-wand-magic-sparkles"></i></div>
      <div class="sb-logo-text">
        <h1>Famelo v8</h1>
        <p>AI Image Ingestion Pro</p>
      </div>
    </div>
  </div>

  <div class="sb-body">

    <!-- AI PROVIDER -->
    <div class="sec-label"><i class="fas fa-robot"></i> Ù…Ø²ÙˆØ¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>

    <div class="provider-select-wrap" id="providerGrid">
      <button class="prov-btn active" data-prov="pollinations" onclick="selectProvider('pollinations')">
        <span class="pb-icon">ğŸŒ¸</span>
        <span class="pb-name">Pollinations</span>
        <span class="pb-badge free-b">Ù…Ø¬Ø§Ù†ÙŠ</span>
      </button>
      <button class="prov-btn" data-prov="openrouter" onclick="selectProvider('openrouter')">
        <span class="pb-icon">ğŸ”€</span>
        <span class="pb-name">OpenRouter</span>
        <span class="pb-badge free-b">Ù…Ø¬Ø§Ù†ÙŠ</span>
      </button>
      <button class="prov-btn" data-prov="groq" onclick="selectProvider('groq')">
        <span class="pb-icon">âš¡</span>
        <span class="pb-name">Groq</span>
        <span class="pb-badge free-b">Ù…Ø¬Ø§Ù†ÙŠ</span>
      </button>
      <button class="prov-btn" data-prov="gemini" onclick="selectProvider('gemini')">
        <span class="pb-icon">âœ¨</span>
        <span class="pb-name">Gemini</span>
        <span class="pb-badge paid-b">Ù…Ø¯ÙÙˆØ¹</span>
      </button>
      <button class="prov-btn" data-prov="huggingface" onclick="selectProvider('huggingface')">
        <span class="pb-icon">ğŸ¤—</span>
        <span class="pb-name">HuggingFace</span>
        <span class="pb-badge free-b">Ù…Ø¬Ø§Ù†ÙŠ</span>
      </button>
      <button class="prov-btn" data-prov="together" onclick="selectProvider('together')">
        <span class="pb-icon">ğŸ¤</span>
        <span class="pb-name">Together</span>
        <span class="pb-badge paid-b">Ù…Ø¯ÙÙˆØ¹</span>
      </button>
    </div>

    <!-- POLLINATIONS -->
    <div class="prov-panel active" id="panel_pollinations">
      <div class="field">
        <label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ <span style="color:var(--green);font-size:.6rem;">(Ø¨Ø¯ÙˆÙ† Ù…ÙØªØ§Ø­ API â€” Ù…Ø¬Ø§Ù†ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹)</span></label>
        <select id="cfg_pol_model" onchange="saveConfig()">
          <option value="openai">OpenAI GPT-4o Vision (Ø§Ù„Ø£Ù‚ÙˆÙ‰)</option>
          <option value="openai-large">OpenAI Large (Ø¯Ù‚ÙŠÙ‚ Ø¬Ø¯Ø§Ù‹)</option>
          <option value="mistral">Mistral (Ø³Ø±ÙŠØ¹)</option>
          <option value="qwen-coder">Qwen Coder (Ù„Ù„ÙƒÙˆØ¯)</option>
        </select>
        <small>âœ… Pollinations.AI Ù…Ø¬Ø§Ù†ÙŠ 100% â€” Ù„Ø§ ÙŠØªØ·Ù„Ø¨ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ø£Ùˆ Ù…ÙØªØ§Ø­Ø§Ù‹</small>
      </div>
      <div class="field">
        <label>Pollinations seed (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø«Ø§Ø¨Øª)</label>
        <input type="number" id="cfg_pol_seed" placeholder="Ù…Ø«Ø§Ù„: 42" onchange="saveConfig()">
      </div>
    </div>

    <!-- OPENROUTER -->
    <div class="prov-panel" id="panel_openrouter">
      <div class="field">
        <label>Ù…ÙØªØ§Ø­ API Ù„Ù€ OpenRouter <span style="color:var(--green);font-size:.6rem;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ù†Ù…Ø§Ø°Ø¬ Ù…Ø¬Ø§Ù†ÙŠØ©)</span></label>
        <div class="key-wrap" id="kw_openrouter">
          <input type="password" id="cfg_or_key" placeholder="sk-or-..." oninput="saveKey('openrouter','cfg_or_key')">
          <button class="key-eye" onclick="toggleEye('cfg_or_key',this)"><i class="fas fa-eye"></i></button>
          <div class="key-saved"></div>
        </div>
        <small>Ø§Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai</a> â€” ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ù…Ø¬Ø§Ù†ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù…ÙØªØ§Ø­</small>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
        <select id="cfg_or_model" onchange="saveConfig()">
          <option value="meta-llama/llama-3.2-11b-vision-instruct:free">Llama 3.2 11B Vision (Ù…Ø¬Ø§Ù†ÙŠ âœ…)</option>
          <option value="meta-llama/llama-3.2-90b-vision-instruct:free">Llama 3.2 90B Vision (Ù…Ø¬Ø§Ù†ÙŠ âœ…)</option>
          <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash Exp (Ù…Ø¬Ø§Ù†ÙŠ âœ…)</option>
          <option value="qwen/qwen2-vl-72b-instruct:free">Qwen2-VL 72B (Ù…Ø¬Ø§Ù†ÙŠ âœ…)</option>
          <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (Ù…Ø¯ÙÙˆØ¹)</option>
        </select>
      </div>
    </div>

    <!-- GROQ -->
    <div class="prov-panel" id="panel_groq">
      <div class="field">
        <label>Ù…ÙØªØ§Ø­ Groq API</label>
        <div class="key-wrap" id="kw_groq">
          <input type="password" id="cfg_groq_key" placeholder="gsk_..." oninput="saveKey('groq','cfg_groq_key')">
          <button class="key-eye" onclick="toggleEye('cfg_groq_key',this)"><i class="fas fa-eye"></i></button>
          <div class="key-saved"></div>
        </div>
        <small>Ù…Ù† <a href="https://console.groq.com/keys" target="_blank">console.groq.com</a> â€” Ù…Ø¬Ø§Ù†ÙŠ: 30 Ø·Ù„Ø¨/Ø¯Ù‚ÙŠÙ‚Ø©</small>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
        <select id="cfg_groq_model" onchange="saveConfig()">
          <option value="llama-3.2-90b-vision-preview">Llama 3.2 90B Vision (Ø§Ù„Ø£ÙØ¶Ù„)</option>
          <option value="llama-3.2-11b-vision-preview">Llama 3.2 11B Vision (Ø£Ø³Ø±Ø¹)</option>
        </select>
      </div>
    </div>

    <!-- GEMINI -->
    <div class="prov-panel" id="panel_gemini">
      <div class="field">
        <label>Ù…ÙØªØ§Ø­ Gemini API</label>
        <div class="key-wrap" id="kw_gemini">
          <input type="password" id="cfg_gem_key" placeholder="AIzaSy..." oninput="saveKey('gemini','cfg_gem_key')">
          <button class="key-eye" onclick="toggleEye('cfg_gem_key',this)"><i class="fas fa-eye"></i></button>
          <div class="key-saved"></div>
        </div>
        <small>Ù…Ù† <a href="https://aistudio.google.com" target="_blank">aistudio.google.com</a></small>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
        <select id="cfg_gem_model" onchange="saveConfig()">
          <option value="gemini-2.5-flash">Gemini 2.5 Flash (Ø§Ù„Ø£Ø­Ø¯Ø«)</option>
          <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite(Ø³Ø±ÙŠØ¹)</option>
          <option value="gemini-1.5-pro">Gemini 1.5 Pro (Ø¯Ù‚ÙŠÙ‚)</option>
        </select>
      </div>
    </div>

    <!-- HUGGINGFACE -->
    <div class="prov-panel" id="panel_huggingface">
      <div class="field">
        <label>Ù…ÙØªØ§Ø­ HuggingFace API</label>
        <div class="key-wrap" id="kw_huggingface">
          <input type="password" id="cfg_hf_key" placeholder="hf_..." oninput="saveKey('huggingface','cfg_hf_key')">
          <button class="key-eye" onclick="toggleEye('cfg_hf_key',this)"><i class="fas fa-eye"></i></button>
          <div class="key-saved"></div>
        </div>
        <small>Ù…Ù† <a href="https://huggingface.co/settings/tokens" target="_blank">huggingface.co</a> â€” Ø·Ø¨Ù‚Ø© Ù…Ø¬Ø§Ù†ÙŠØ©</small>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
        <select id="cfg_hf_model" onchange="saveConfig()">
          <option value="Qwen/Qwen2-VL-7B-Instruct">Qwen2-VL 7B (Ù…ÙˆØµÙ‰ Ø¨Ù‡)</option>
          <option value="microsoft/Phi-3.5-vision-instruct">Phi-3.5 Vision</option>
        </select>
      </div>
    </div>

    <!-- TOGETHER -->
    <div class="prov-panel" id="panel_together">
      <div class="field">
        <label>Ù…ÙØªØ§Ø­ Together AI API</label>
        <div class="key-wrap" id="kw_together">
          <input type="password" id="cfg_tog_key" placeholder="Ø±Ù…Ø² Together AI..." oninput="saveKey('together','cfg_tog_key')">
          <button class="key-eye" onclick="toggleEye('cfg_tog_key',this)"><i class="fas fa-eye"></i></button>
          <div class="key-saved"></div>
        </div>
        <small>Ù…Ù† <a href="https://together.ai" target="_blank">together.ai</a></small>
      </div>
      <div class="field">
        <label>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
        <select id="cfg_tog_model" onchange="saveConfig()">
          <option value="meta-llama/Llama-3.2-11B-Vision-Instruct-Turbo">Llama 3.2 Vision 11B</option>
          <option value="meta-llama/Llama-3.2-90B-Vision-Instruct-Turbo">Llama 3.2 Vision 90B (Ø£ÙØ¶Ù„)</option>
        </select>
      </div>
    </div>

    <!-- LANGUAGE & PROMPT -->
    <div class="sec-label"><i class="fas fa-language"></i> Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ù€ Prompt</div>
    <div class="field">
      <label>Ù„ØºØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</label>
      <select id="cfg_lang" onchange="saveConfig()">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
        <option value="both">ÙƒÙ„Ø§Ù‡Ù…Ø§ (AR + EN)</option>
      </select>
    </div>
    <div class="field">
      <label>Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</label>
      <textarea id="cfg_prompt" rows="3" onchange="saveConfig()">Ø­Ù„Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ØªÙØµÙŠÙ„. Ø£Ø¹Ø¯ JSON ÙÙ‚Ø· Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.</textarea>
    </div>

    <!-- TEMPLATE STRUCTURE -->
    <div class="sec-label"><i class="fas fa-table"></i> Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
    <div class="tpl-tabs">
      <button class="tpl-tab active" id="tab_json" onclick="switchTplMode('json')"><i class="fas fa-code"></i> JSON Ù…Ø¨Ø§Ø´Ø±</button>
      <button class="tpl-tab" id="tab_csv" onclick="switchTplMode('csv')"><i class="fas fa-file-csv"></i> Ù‚Ø§Ù„Ø¨ CSV</button>
    </div>
    <div id="tpl_json_wrap">
      <div class="field">
        <label>Ù‡ÙŠÙƒÙ„ JSON Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
        <textarea id="cfg_json" rows="8" onchange="saveConfig()" style="font-family:'JetBrains Mono',monospace;font-size:.72rem;">{
  "Ø§Ù„Ø§Ø³Ù…": "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬",
  "Ø§Ù„Ø±Ù…Ø²": "ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬",
  "Ø§Ù„Ø³Ø¹Ø±": 0,
  "Ø§Ù„ÙˆØµÙ_Ø§Ù„Ù…Ø®ØªØµØ±": "ÙˆØµÙ Ù‚ØµÙŠØ±",
  "Ø§Ù„ÙˆØµÙ_Ø§Ù„ÙƒØ§Ù…Ù„": "ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ",
  "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†_Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ": "Ø¹Ù†ÙˆØ§Ù† SEO",
  "Ø§Ù„ÙˆØµÙ_Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ": "ÙˆØµÙ SEO"
}</textarea>
      </div>
    </div>
    <div id="tpl_csv_wrap" style="display:none;">
      <div class="field">
        <label>Ø±ÙØ¹ Ù…Ù„Ù CSV ÙƒÙ‚Ø§Ù„Ø¨</label>
        <div class="csv-drop" id="csvDrop" onclick="document.getElementById('csvFileInput').click()">
          <i class="fas fa-file-csv"></i>
          <span id="csvDropLabel">Ø§Ù†Ù‚Ø± Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù CSV Ù‡Ù†Ø§</span>
          <input type="file" id="csvFileInput" accept=".csv,.tsv" style="display:none" onchange="handleCsvTemplate(event)">
        </div>
        <small>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙ Ø±Ø£Ø³ + ØµÙÙˆÙ Ù…Ø«Ø§Ù„. Ø³ÙŠÙØ³ØªØ®Ø¯Ù… ÙƒÙ‚Ø§Ù„Ø¨ Ù„Ù„Ù€ AI.</small>
      </div>
      <div id="csvColsWrap" style="display:none;">
        <div class="csv-cols" id="csvColTags"></div>
        <div class="csv-sample" id="csvSampleBox"></div>
      </div>
    </div>

    <!-- IMAGE SETTINGS -->
    <div class="sec-label"><i class="fas fa-image"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØ±</div>
    <div class="field">
      <label>Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±</label>
      <input type="text" id="cfg_path" value="catalog/products/" onchange="saveConfig()">
    </div>
    <div class="field">
      <label>ØªØ³Ù…ÙŠØ© Ø§Ù„ØµÙˆØ±</label>
      <select id="cfg_naming" onchange="toggleNaming();saveConfig()">
        <option value="original">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„ÙŠ</option>
        <option value="pattern">Ù†Ù…Ø· Ù…Ø®ØµØµ</option>
      </select>
    </div>
    <div class="field" id="namingPatternWrap" style="display:none;">
      <label>Ø§Ù„Ù†Ù…Ø· (Ø§Ø³ØªØ®Ø¯Ù… {i} Ù„Ù„ØªØ±Ù‚ÙŠÙ…)</label>
      <input type="text" id="cfg_pattern" value="product_{i}" onchange="saveConfig()">
    </div>

    <!-- PROCESSING -->
    <div class="sec-label"><i class="fas fa-sliders-h"></i> Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
    <div class="field">
      <label>Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ²Ø§Ù…Ù†Ø©</label>
      <select id="cfg_concurrent" onchange="saveConfig()">
        <option value="1">1 Ù…Ù„Ù (Ø¢Ù…Ù†)</option>
        <option value="2">2 Ù…Ù„ÙØ§Øª</option>
        <option value="3" selected>3 Ù…Ù„ÙØ§Øª (Ù…ÙˆØµÙ‰ Ø¨Ù‡)</option>
        <option value="5">5 Ù…Ù„ÙØ§Øª (Ø³Ø±ÙŠØ¹)</option>
      </select>
    </div>
    <div class="field">
      <label>Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø§Ø¯Ø©</label>
      <select id="cfg_retries" onchange="saveConfig()">
        <option value="0">Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø©</option>
        <option value="1">Ù…Ø­Ø§ÙˆÙ„Ø©</option>
        <option value="2" selected>Ù…Ø­Ø§ÙˆÙ„ØªØ§Ù†</option>
        <option value="3">3 Ù…Ø­Ø§ÙˆÙ„Ø§Øª</option>
      </select>
    </div>
    <div class="field">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="cfg_bgMode" onchange="saveConfig()" style="width:auto;accent-color:var(--glow);">
        Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
      </label>
    </div>

    <!-- EXPORT -->
    <div class="sec-label"><i class="fas fa-download"></i> ØªØ³Ù…ÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ±</div>
    <div class="field">
      <input type="text" id="cfg_outRule" value="famelo_export_{date}" onchange="saveConfig()">
    </div>

  </div><!-- /sb-body -->

  <div class="sb-foot">
    <button class="btn btn-ghost" onclick="testConnection()" style="font-size:.78rem;">
      <i class="fas fa-plug"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
    </button>
  </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="main">

  <!-- STATS HEADER -->
  <div class="stat-header">
    <div class="stat-top">
      <div class="stat-title">
        <i class="fas fa-microchip" style="color:var(--glow);"></i>
        <span id="statusTitle">Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
      </div>
      <div class="provider-pill" id="provPill">
        <div class="pulse"></div>
        <span id="provPillText">â€” Ø§Ø®ØªØ± Ù…Ø²ÙˆØ¯Ø§Ù‹ â€”</span>
      </div>
    </div>
    <div class="stats-grid">
      <div class="sbox s-info"><div class="slbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="sval" id="stat_total">0</div></div>
      <div class="sbox s-ok"><div class="slbl">Ù…ÙƒØªÙ…Ù„</div><div class="sval" id="stat_done">0</div></div>
      <div class="sbox s-warn"><div class="slbl">Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„</div><div class="sval" id="stat_active">0</div></div>
      <div class="sbox s-err"><div class="slbl">ÙØ´Ù„</div><div class="sval" id="stat_error">0</div></div>
    </div>
    <div class="pbar-track"><div class="pbar-fill" id="progressBar"></div></div>
    <div class="pbar-meta">
      <span id="progressPct">0%</span>
      <span id="progressLabel">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡...</span>
    </div>
    <div class="cur-task" id="curTask">
      <i class="fas fa-spinner fa-spin"></i>
      <span id="curTaskText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>
    </div>
    <div class="ctrl-btns" id="ctrlBtns" style="display:none;">
      <button class="btn btn-warning btn-sm" id="btnPause" onclick="pauseProcessing()"><i class="fas fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
      <button class="btn btn-danger btn-sm" id="btnStop" onclick="stopProcessing()"><i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù ÙƒØ§Ù…Ù„</button>
    </div>
  </div>
    <!-- START BUTTON -->
  <button class="btn btn-primary" id="btnStart" onclick="startWorkflow()">
    <i class="fas fa-play"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
  </button>
  <!-- DROP ZONE -->
  <div class="drop-zone" id="dropZone"
    ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
    onclick="document.getElementById('fileInput').click()">
    <i class="fas fa-cloud-upload-alt dz-icon"></i>
    <div class="dz-title">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</div>
    <div class="dz-sub">PNG Â· JPG Â· WEBP Â· Ø­ØªÙ‰ 100 ØµÙˆØ±Ø©</div>
    <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
  </div>

  <!-- IMAGE GRID -->
  <div class="img-grid" id="imageGrid"></div>

  <!-- EXPORT PANEL -->
  <div class="export-panel" id="exportPanel">
    <div class="export-panel-head"><i class="fas fa-check-circle"></i> Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© â€” ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
    <div class="export-row">
      <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</label><input type="text" id="final_name" value="famelo_export"></div>
      <div class="field">
        <label>Ø§Ù„ØµÙŠØºØ©</label>
        <select id="final_type">
          <option value="xlsx">Excel (.xlsx)</option>
          <option value="csv">CSV (.csv)</option>
          <option value="json">JSON (.json)</option>
        </select>
      </div>
    </div>
    <button class="btn btn-success" onclick="generateAndDownload()" style="margin-top:12px;">
      <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
    </button>
  </div>

  <!-- LOGS -->
  <div class="logs-panel">
    <div class="logs-head">
      <div class="logs-head-left"><i class="fas fa-terminal" style="color:var(--glow);"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
      <div class="logs-btns">
        <button class="log-btn" onclick="exportLogs()"><i class="fas fa-download"></i> ØªØµØ¯ÙŠØ±</button>
        <button class="log-btn" onclick="clearLogs()"><i class="fas fa-trash"></i> Ù…Ø³Ø­</button>
      </div>
    </div>
    <div id="log-area"></div>
  </div>



</main>

<!-- DETAIL MODAL -->
<div class="modal" id="modal" onclick="if(event.target===this)this.style.display='none'">
  <div class="modal-box">
    <div class="modal-head">
      <h3><i class="fas fa-info-circle" style="color:var(--glow);"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3>
      <button class="modal-close" onclick="document.getElementById('modal').style.display='none'"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let filesData = [], globalResults = [];
let processingStats = {total:0,done:0,active:0,error:0};
let isProcessing=false, isPaused=false, isStopped=false;
let currentBatchIndex=0, logHistory=[];
const MAX_LOGS = 1000;

// CSV template state
let csvColumns = null;   // string[]
let csvSamples = null;   // object[]
let tplMode    = 'json'; // 'json' | 'csv'
let currentProvider = 'pollinations';

// Persistent-key storage keys per provider
const KEY_STORE = {
  openrouter:'fv8_key_openrouter',
  groq:      'fv8_key_groq',
  gemini:    'fv8_key_gemini',
  huggingface:'fv8_key_huggingface',
  together:  'fv8_key_together',
};
const CFG_STORE  = 'fv8_cfg';
const LOG_STORE  = 'fv8_logs';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  loadConfig();
  loadPersistedKeys();
  loadLogHistory();
  updateProviderUI();
  if('Notification' in window && Notification.permission==='default') Notification.requestPermission();
  log('Famelo v8 Ø¬Ø§Ù‡Ø² â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ','success');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG PERSISTENCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveConfig() {
  const cfg = {};
  // Non-key fields
  ['cfg_pol_model','cfg_pol_seed','cfg_or_model','cfg_groq_model',
   'cfg_gem_model','cfg_hf_model','cfg_tog_model','cfg_lang','cfg_prompt',
   'cfg_json','cfg_path','cfg_naming','cfg_pattern','cfg_concurrent',
   'cfg_retries','cfg_bgMode','cfg_outRule'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    cfg[id] = el.type==='checkbox' ? el.checked : el.value;
  });
  cfg._provider = currentProvider;
  try { localStorage.setItem(CFG_STORE, JSON.stringify(cfg)); } catch(e){}
  updateProviderUI();
}

function loadConfig() {
  try {
    const raw = localStorage.getItem(CFG_STORE);
    if (!raw) return;
    const cfg = JSON.parse(raw);
    Object.keys(cfg).forEach(id => {
      if (id.startsWith('_')) return;
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type==='checkbox') el.checked = cfg[id];
      else el.value = cfg[id];
    });
    if (cfg._provider) { currentProvider=cfg._provider; selectProvider(currentProvider,true); }
  } catch(e){}
  toggleNaming();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PER-PROVIDER KEY PERSISTENCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KEY_FIELDS = {
  openrouter:'cfg_or_key', groq:'cfg_groq_key',
  gemini:'cfg_gem_key', huggingface:'cfg_hf_key', together:'cfg_tog_key',
};

function saveKey(provider, fieldId) {
  const val = document.getElementById(fieldId)?.value?.trim() || '';
  const storageKey = KEY_STORE[provider];
  if (!storageKey) return;
  try {
    if (val) { localStorage.setItem(storageKey, val); }
    else { localStorage.removeItem(storageKey); }
  } catch(e){}
  // Show saved indicator
  const kw = document.getElementById('kw_'+provider);
  if (kw) kw.classList.toggle('saved', !!val);
  saveConfig();
}

function loadPersistedKeys() {
  Object.entries(KEY_STORE).forEach(([prov, storageKey]) => {
    const val = localStorage.getItem(storageKey);
    if (!val) return;
    const fieldId = KEY_FIELDS[prov];
    const el = fieldId && document.getElementById(fieldId);
    if (el) {
      el.value = val;
      const kw = document.getElementById('kw_'+prov);
      if (kw) kw.classList.add('saved');
    }
  });
}

function getKey(provider) {
  const fieldId = KEY_FIELDS[provider];
  const fromEl = fieldId && document.getElementById(fieldId)?.value?.trim();
  if (fromEl) return fromEl;
  return localStorage.getItem(KEY_STORE[provider]) || '';
}

function toggleEye(fieldId, btn) {
  const el = document.getElementById(fieldId);
  if (!el) return;
  const isHidden = el.type==='password';
  el.type = isHidden ? 'text' : 'password';
  btn.innerHTML = isHidden ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROVIDER UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROVIDER_NAMES = {
  pollinations:'ğŸŒ¸ Pollinations (Ù…Ø¬Ø§Ù†ÙŠ)',
  openrouter:'ğŸ”€ OpenRouter',
  groq:'âš¡ Groq',
  gemini:'âœ¨ Gemini',
  huggingface:'ğŸ¤— HuggingFace',
  together:'ğŸ¤ Together AI',
};

function selectProvider(p, silent=false) {
  currentProvider = p;
  // Update buttons
  document.querySelectorAll('.prov-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.prov===p);
  });
  // Update panels
  document.querySelectorAll('.prov-panel').forEach(panel => {
    panel.classList.toggle('active', panel.id==='panel_'+p);
  });
  if (!silent) saveConfig();
  updateProviderUI();
}

function updateProviderUI() {
  const pill = document.getElementById('provPill');
  document.getElementById('provPillText').textContent = PROVIDER_NAMES[currentProvider] || currentProvider;
  pill.classList.toggle('active', isProcessing);
}

function toggleNaming() {
  const mode = document.getElementById('cfg_naming').value;
  document.getElementById('namingPatternWrap').style.display = mode==='pattern' ? 'block' : 'none';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TEMPLATE MODE (JSON / CSV)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTplMode(mode) {
  tplMode = mode;
  document.getElementById('tab_json').classList.toggle('active', mode==='json');
  document.getElementById('tab_csv').classList.toggle('active', mode==='csv');
  document.getElementById('tpl_json_wrap').style.display = mode==='json' ? 'block' : 'none';
  document.getElementById('tpl_csv_wrap').style.display = mode==='csv' ? 'block' : 'none';
}

function handleCsvTemplate(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => parseCsvTemplate(ev.target.result, file.name);
  reader.readAsText(file, 'UTF-8');
}

// Allow drag-drop on csv zone
(function(){
  document.addEventListener('DOMContentLoaded', () => {
    const zone = document.getElementById('csvDrop');
    if (!zone) return;
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.style.borderColor='var(--cyan)'; });
    zone.addEventListener('dragleave', () => zone.style.borderColor='');
    zone.addEventListener('drop', e => {
      e.preventDefault(); zone.style.borderColor='';
      const f = e.dataTransfer.files[0];
      if (f) { const r=new FileReader(); r.onload=ev=>parseCsvTemplate(ev.target.result,f.name); r.readAsText(f,'UTF-8'); }
    });
  });
})();

function parseCsvTemplate(text, fileName) {
  // Strip BOM
  const clean = text.replace(/^\uFEFF/,'');
  const lines = clean.split(/\r?\n/).filter(l=>l.trim());
  if (!lines.length) { showNotification('Ø®Ø·Ø£','Ù…Ù„Ù CSV ÙØ§Ø±Øº','error'); return; }

  // CSV parser (handles quoted commas)
  function parseRow(line) {
    const r=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){ inQ=!inQ; } else if(c===','&&!inQ){ r.push(cur.trim()); cur=''; } else cur+=c;
    }
    r.push(cur.trim()); return r;
  }

  const headers = parseRow(lines[0]).map(h=>h.replace(/^"|"$/g,'').trim());
  csvColumns = headers;
  csvSamples = [];
  for(let i=1;i<Math.min(lines.length,5);i++){
    const vals = parseRow(lines[i]);
    const obj={}; headers.forEach((h,idx)=>{ obj[h]=(vals[idx]||'').replace(/^"|"$/g,'').trim(); });
    csvSamples.push(obj);
  }

  // UI feedback
  const zone = document.getElementById('csvDrop');
  zone.classList.add('loaded');
  document.getElementById('csvDropLabel').textContent = `âœ“ ${fileName} (${headers.length} Ø¹Ù…ÙˆØ¯)`;

  document.getElementById('csvColsWrap').style.display='block';
  document.getElementById('csvColTags').innerHTML = headers.map(h=>`<span class="csv-col-tag">${h}</span>`).join('');

  const sampleBox = document.getElementById('csvSampleBox');
  if(csvSamples[0]){
    const sampleObj={}; headers.forEach(h=>{ sampleObj[h]=csvSamples[0][h]||`Ù‚ÙŠÙ…Ø© ${h}`; });
    sampleBox.textContent = JSON.stringify(sampleObj,null,2);
    sampleBox.classList.add('show');
  }

  log(`Ù‚Ø§Ù„Ø¨ CSV: ${headers.length} Ø¹Ù…ÙˆØ¯ Ù…Ù† "${fileName}"`, 'success');
  showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨',`${headers.length} Ø¹Ù…ÙˆØ¯: ${headers.slice(0,3).join(', ')}...`,'success');
}

function buildStructureForAI() {
  if (tplMode==='csv' && csvColumns) {
    const obj={};
    csvColumns.forEach(col => { obj[col]=csvSamples?.[0]?.[col]||`Ù‚ÙŠÙ…Ø© ${col}`; });
    return JSON.stringify(obj,null,2);
  }
  return document.getElementById('cfg_json').value;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTIFICATIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNotification(title, msg, type='success') {
  const icons={success:'fa-check-circle',error:'fa-exclamation-circle',warning:'fa-exclamation-triangle',info:'fa-info-circle'};
  const div=document.createElement('div');
  div.className=`notif ${type}`;
  div.innerHTML=`<i class="fas ${icons[type]||icons.info}"></i><div class="notif-content"><div class="notif-title">${title}</div><div class="notif-msg">${msg}</div></div><button class="notif-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
  document.getElementById('notifContainer').appendChild(div);
  setTimeout(()=>{ div.style.opacity='0'; div.style.transform='translateX(-110%)'; div.style.transition='all .3s'; setTimeout(()=>div.remove(),350); },5000);
  if(type==='success'||type==='error') beep(type);
}

function beep(type) {
  try{
    const ac=new(window.AudioContext||window.webkitAudioContext)();
    const o=ac.createOscillator(),g=ac.createGain();
    o.connect(g); g.connect(ac.destination);
    o.frequency.value=type==='success'?880:380; o.type='sine';
    g.gain.setValueAtTime(.2,ac.currentTime);
    g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.35);
    o.start(); o.stop(ac.currentTime+.35);
  }catch(e){}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGGING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg,type='info'){
  const area=document.getElementById('log-area');
  const ts=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const icons={success:'âœ“',error:'âœ—',info:'Â·',sys:'âš™',warning:'!'};
  const row=document.createElement('div');
  row.className=`log-row log-${type}`;
  row.innerHTML=`<span class="log-ts">[${ts}]</span><span class="log-ic">${icons[type]||'Â·'}</span><span class="log-msg">${msg}</span>`;
  area.appendChild(row); area.scrollTop=area.scrollHeight;
  logHistory.push({ts:new Date().toISOString(),type,msg});
  if(logHistory.length>MAX_LOGS) logHistory=logHistory.slice(-MAX_LOGS);
  try{localStorage.setItem(LOG_STORE,JSON.stringify(logHistory));}catch(e){}
}

function loadLogHistory(){
  try{
    const raw=localStorage.getItem(LOG_STORE);
    if(!raw) return;
    logHistory=JSON.parse(raw);
    const area=document.getElementById('log-area');
    const icons={success:'âœ“',error:'âœ—',info:'Â·',sys:'âš™',warning:'!'};
    logHistory.slice(-20).forEach(entry=>{
      const ts=new Date(entry.ts).toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
      const row=document.createElement('div');
      row.className=`log-row log-${entry.type}`;
      row.innerHTML=`<span class="log-ts">[${ts}]</span><span class="log-ic">${icons[entry.type]||'Â·'}</span><span class="log-msg">${entry.msg}</span>`;
      area.appendChild(row);
    });
    area.scrollTop=area.scrollHeight;
  }catch(e){}
}

function clearLogs(){
  if(confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ')){ document.getElementById('log-area').innerHTML=''; logHistory=[]; localStorage.removeItem(LOG_STORE); log('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª','info'); }
}

function exportLogs(){
  if(!logHistory.length){showNotification('Ù„Ø§ Ø³Ø¬Ù„Ø§Øª','','warning');return;}
  let txt=`=== Famelo v8 Logs â€” ${new Date().toLocaleString('ar-SA')} ===\n\n`;
  logHistory.forEach(e=>{txt+=`[${new Date(e.ts).toLocaleString()}] [${e.type.toUpperCase()}] ${e.msg}\n`;});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([txt],{type:'text/plain'}));
  a.download=`famelo_logs_${new Date().toISOString().split('T')[0]}.txt`; a.click();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILE HANDLING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDragOver(e){e.preventDefault();e.currentTarget.classList.add('dragover');}
function handleDragLeave(e){e.currentTarget.classList.remove('dragover');}
function handleDrop(e){
  e.preventDefault();e.currentTarget.classList.remove('dragover');
  const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'));
  loadFiles(files);
}
function handleFileSelect(e){
  const files=Array.from(e.target.files).filter(f=>f.type.startsWith('image/')); loadFiles(files);
}

function loadFiles(files){
  if(!files.length){showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±','Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª ØµÙˆØ± ØµØ§Ù„Ø­Ø©','warning');return;}
  if(files.length>100){showNotification('ØªØ­Ø°ÙŠØ±','ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ 100 ØµÙˆØ±Ø©','warning');files=files.slice(0,100);}
  filesData=files.map((f,i)=>({id:Date.now()+i,file:f,status:'pending',progress:0,result:null,error:null}));
  renderGrid(); updateStats();
  log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${files.length} ØµÙˆØ±Ø©`,'success');
  showNotification('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„',`${files.length} ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø©`,'success');
  document.getElementById('btnStart').disabled=false;
  isPaused=false; isStopped=false; currentBatchIndex=0;
  document.getElementById('exportPanel').classList.remove('show');
}

function renderGrid(){
  const grid=document.getElementById('imageGrid');
  grid.innerHTML='';
  filesData.forEach(item=>{
    const card=document.createElement('div');
    card.className=`img-card ${item.status}`;
    card.onclick=()=>item.result&&showDetails(item.id);
    const img=document.createElement('img');
    img.src=URL.createObjectURL(item.file);
    card.appendChild(img);
    const ov=document.createElement('div');
    ov.className='card-overlay'; ov.id=`ov_${item.id}`;
    ov.innerHTML=`<svg width="54" height="54" class="ring"><circle cx="27" cy="27" r="22" stroke="#1c2133" stroke-width="3.5" fill="none"/><circle cx="27" cy="27" r="22" stroke="#5b4af8" stroke-width="3.5" fill="none" class="ring-circle" id="rc_${item.id}" stroke-dasharray="138" stroke-dashoffset="138"/></svg><div class="pct-txt" id="pct_${item.id}">0%</div><div class="card-status-badge" id="badge_${item.id}">Ø§Ù†ØªØ¸Ø§Ø±</div><div class="card-sub" id="sub_${item.id}"></div>`;
    card.appendChild(ov);
    grid.appendChild(card);
  });
}

function updateStats(){
  processingStats={
    total:filesData.length,
    done:filesData.filter(f=>f.status==='done').length,
    active:filesData.filter(f=>f.status==='processing').length,
    error:filesData.filter(f=>f.status==='error').length,
  };
  ['total','done','active','error'].forEach(k=>document.getElementById(`stat_${k}`).textContent=processingStats[k]);
  const pct=processingStats.total>0?Math.round(processingStats.done/processingStats.total*100):0;
  document.getElementById('progressBar').style.width=pct+'%';
  document.getElementById('progressPct').textContent=pct+'%';
  let lbl='ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡...';
  if(isPaused) lbl='Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹';
  else if(isStopped) lbl='ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù';
  else if(processingStats.active>0) lbl=`Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ${processingStats.active}/${processingStats.total}`;
  else if(processingStats.done===processingStats.total&&processingStats.total>0) lbl='Ø§ÙƒØªÙ…Ù„ âœ“';
  document.getElementById('progressLabel').textContent=lbl;
}

function setCardProgress(id,pct,badge,sub=''){
  const ov=document.getElementById(`ov_${id}`);
  if(ov) ov.style.display='flex';
  const rc=document.getElementById(`rc_${id}`);
  if(rc) rc.style.strokeDashoffset=138-(pct/100)*138;
  const p=document.getElementById(`pct_${id}`); if(p) p.textContent=Math.round(pct)+'%';
  const b=document.getElementById(`badge_${id}`); if(b) b.textContent=badge;
  const s=document.getElementById(`sub_${id}`); if(s) s.textContent=sub;
}
function hideCardOverlay(id){const ov=document.getElementById(`ov_${id}`);if(ov)ov.style.display='none';}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROCESS CONTROL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startWorkflow(){
  if(!filesData.length){showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±','Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹','warning');return;}
  isPaused=false; isStopped=false; currentBatchIndex=0; globalResults=[];
  filesData.forEach(item=>{if(item.status!=='done'){item.status='pending';item.progress=0;item.error=null;hideCardOverlay(item.id);}});
  renderGrid();
  isProcessing=true;
  document.getElementById('btnStart').disabled=true;
  document.getElementById('statusTitle').textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
  document.getElementById('curTask').style.display='flex';
  document.getElementById('ctrlBtns').style.display='flex';
  document.getElementById('btnPause').innerHTML='<i class="fas fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
  document.getElementById('btnPause').className='btn btn-warning btn-sm';
  document.getElementById('exportPanel').classList.remove('show');
  updateProviderUI();
  log('Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© â€” Ø§Ù„Ù…Ø²ÙˆØ¯: '+PROVIDER_NAMES[currentProvider],'sys');
  if(document.getElementById('cfg_bgMode').checked) showNotification('Ø®Ù„ÙÙŠØ©','Ø³ØªØªÙ„Ù‚Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡','info');
  try{
    await processAll();
    if(!isStopped){showNotification('Ø§ÙƒØªÙ…Ù„!',`${processingStats.done}/${processingStats.total} ØµÙˆØ±Ø©`,'success');finishWorkflow();}
  }catch(err){
    if(!isStopped){showNotification('Ø®Ø·Ø£',err.message,'error');log('ÙØ´Ù„: '+err.message,'error');}
  }finally{
    if(!isStopped){document.getElementById('curTask').style.display='none';document.getElementById('ctrlBtns').style.display='none';isProcessing=false;updateProviderUI();}
  }
}

async function processAll(){
  const n=parseInt(document.getElementById('cfg_concurrent').value);
  for(let i=0;i<filesData.length;i+=n){
    if(isStopped) break;
    while(isPaused&&!isStopped) await sleep(500);
    if(isStopped) break;
    currentBatchIndex=i;
    const batch=filesData.slice(i,i+n).filter(f=>f.status!=='done');
    if(batch.length) await Promise.all(batch.map(item=>processFile(item)));
  }
}

async function processFile(item){
  const retries=parseInt(document.getElementById('cfg_retries').value);
  let attempts=0;
  while(attempts<=retries){
    if(isStopped) return;
    while(isPaused&&!isStopped) await sleep(500);
    if(isStopped) return;
    try{
      item.status='processing'; updateStats(); renderGrid();
      setCardProgress(item.id,0,'Ø¨Ø¯Ø¡','');
      document.getElementById('curTaskText').textContent=`Ù…Ø¹Ø§Ù„Ø¬Ø©: ${item.file.name}`;
      setCardProgress(item.id,10,'Ù‚Ø±Ø§Ø¡Ø©','ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...');
      const b64=await readAsBase64(item.file,p=>setCardProgress(item.id,10+p*.2,'Ù‚Ø±Ø§Ø¡Ø©',Math.round(p)+'%'));
      if(isStopped) return;
      setCardProgress(item.id,30,'ØªØ­Ù„ÙŠÙ„','Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ AI...');
      const result=await callAI(b64,(p,s)=>setCardProgress(item.id,30+p*.6,'ØªØ­Ù„ÙŠÙ„',s));
      if(isStopped) return;
      setCardProgress(item.id,95,'Ø¥Ù†Ù‡Ø§Ø¡','');
      const finalData=buildFinalData(item.file,result,filesData.indexOf(item));
      item.result=finalData; item.status='done'; globalResults.push(finalData);
      setCardProgress(item.id,100,'Ø§ÙƒØªÙ…Ù„','âœ“');
      setTimeout(()=>hideCardOverlay(item.id),800);
      log(`âœ“ ${item.file.name}`,'success'); updateStats(); renderGrid();
      return;
    }catch(err){
      attempts++;
      if(isStopped) return;
      if(attempts<=retries){
        log(`âš  Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts}/${retries} â€” ${item.file.name}: ${err.message}`,'warning');
        setCardProgress(item.id,50,'Ø¥Ø¹Ø§Ø¯Ø©',`Ù…Ø­Ø§ÙˆÙ„Ø© ${attempts+1}...`);
        await sleep(2000);
      }else{
        item.status='error'; item.error=err.message;
        setCardProgress(item.id,100,'ÙØ´Ù„',err.message.slice(0,30));
        log(`âœ— ${item.file.name}: ${err.message}`,'error');
        updateStats(); renderGrid();
      }
    }
  }
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

function readAsBase64(file,onProg){
  return new Promise((res,rej)=>{
    const reader=new FileReader();
    reader.onprogress=e=>{if(e.lengthComputable)onProg(e.loaded/e.total*100);};
    reader.onload=()=>res(reader.result); reader.onerror=rej;
    reader.readAsDataURL(file);
  });
}

function buildFinalData(file,aiJson,idx){
  const mode=document.getElementById('cfg_naming').value;
  const ext=file.name.split('.').pop();
  const pattern=document.getElementById('cfg_pattern').value;
  const name=mode==='pattern'?pattern.replace('{i}',idx+1)+'.'+ext:file.name;
  const path=document.getElementById('cfg_path').value;
  return{...aiJson,Ø§Ø³Ù…_Ø§Ù„ØµÙˆØ±Ø©:name,Ø§Ù„Ù…Ø³Ø§Ø±_Ø§Ù„ÙƒØ§Ù…Ù„:path+name};
}

function pauseProcessing(){
  if(!isProcessing) return;
  isPaused=!isPaused;
  const btn=document.getElementById('btnPause');
  if(isPaused){
    btn.innerHTML='<i class="fas fa-play"></i> Ø§Ø³ØªØ¦Ù†Ø§Ù'; btn.className='btn btn-success btn-sm';
    log('ØªÙˆÙ‚Ù Ù…Ø¤Ù‚Øª','warning'); showNotification('ØªÙˆÙ‚Ù Ù…Ø¤Ù‚Øª','','warning');
    document.getElementById('statusTitle').textContent='Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹';
  }else{
    btn.innerHTML='<i class="fas fa-pause"></i> Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª'; btn.className='btn btn-warning btn-sm';
    log('Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©','info'); showNotification('Ø§Ø³ØªØ¦Ù†Ø§Ù','','info');
    document.getElementById('statusTitle').textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
  }
  updateStats();
}

function stopProcessing(){
  if(!isProcessing) return;
  if(!confirm('Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
  isStopped=true; isPaused=false; isProcessing=false;
  log('ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù','error');
  document.getElementById('statusTitle').textContent='ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù';
  document.getElementById('curTask').style.display='none';
  document.getElementById('ctrlBtns').style.display='none';
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStart').innerHTML='<i class="fas fa-redo"></i> Ø¨Ø¯Ø¡ Ø¬Ø¯ÙŠØ¯';
  updateProviderUI(); updateStats();
  filesData.forEach(item=>{if(['processing','pending'].includes(item.status)){item.status='error';item.error='Ø£ÙÙˆÙ‚Ù';hideCardOverlay(item.id);}});
  renderGrid();
}

function finishWorkflow(){
  isProcessing=false; isPaused=false;
  log('Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª!','success');
  document.getElementById('statusTitle').textContent='Ø§ÙƒØªÙ…Ù„!';
  document.getElementById('ctrlBtns').style.display='none';
  const rule=document.getElementById('cfg_outRule').value;
  document.getElementById('final_name').value=rule.replace('{date}',new Date().toISOString().split('T')[0]);
  document.getElementById('exportPanel').classList.add('show');
  document.getElementById('btnStart').disabled=false;
  document.getElementById('btnStart').innerHTML='<i class="fas fa-redo"></i> Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ø¯ÙŠØ¯Ø©';
  document.getElementById('exportPanel').scrollIntoView({behavior:'smooth',block:'nearest'});
  updateProviderUI();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI PROVIDERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPrompt(){
  const base=document.getElementById('cfg_prompt').value;
  const lang=document.getElementById('cfg_lang').value;
  const lmap={ar:'Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·.',en:'Answer in English only.',both:'Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.'};
  return `${base}\n\n${lmap[lang]||''}`;
}

function extractJSON(text){
  if(!text) throw new Error('AI Ù„Ù… ÙŠØ±Ø¯ Ø¨Ù†Øµ');
  // Try ```json block first
  const m1=text.match(/```json\s*([\s\S]*?)```/);
  const m2=text.match(/```\s*([\s\S]*?)```/);
  const jsonStr=(m1?m1[1]:m2?m2[1]:text).trim();
  // Find outermost {} or []
  const first=jsonStr.search(/[{[]/);
  if(first===-1) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ JSON ØµØ§Ù„Ø­');
  const partial=jsonStr.slice(first);
  const last=Math.max(partial.lastIndexOf('}'),partial.lastIndexOf(']'));
  if(last===-1) throw new Error('Ù‡ÙŠÙƒÙ„ JSON ØºÙŠØ± Ù…ÙƒØªÙ…Ù„');
  try{ return JSON.parse(partial.slice(0,last+1)); }
  catch(e){ throw new Error('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSON: '+e.message); }
}

async function callAI(b64,onProgress){
  switch(currentProvider){
    case 'pollinations': return await callPollinations(b64,onProgress);
    case 'openrouter':   return await callOpenRouter(b64,onProgress);
    case 'gemini':       return await callGemini(b64,onProgress);
    case 'groq':         return await callGroq(b64,onProgress);
    case 'huggingface':  return await callHuggingFace(b64,onProgress);
    case 'together':     return await callTogether(b64,onProgress);
    default: throw new Error('Ù…Ø²ÙˆØ¯ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: '+currentProvider);
  }
}

async function testConnection(){
  log(`Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€” ${PROVIDER_NAMES[currentProvider]}...`,'sys');
  try{
    const c=document.createElement('canvas'); c.width=8;c.height=8;
    const ctx=c.getContext('2d'); ctx.fillStyle='#ccc'; ctx.fillRect(0,0,8,8);
    await callAI(c.toDataURL('image/png'),()=>{});
    showNotification('Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„',`${PROVIDER_NAMES[currentProvider]} ÙŠØ¹Ù…Ù„ âœ“`,'success');
    log('Ù†Ø¬Ø­ Ø§Ù„Ø§ØªØµØ§Ù„','success');
  }catch(e){
    showNotification('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„',e.message,'error');
    log('ÙØ´Ù„: '+e.message,'error');
  }
}

// â”€â”€ 1. POLLINATIONS.AI (100% FREE, No Key) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callPollinations(b64, onProgress){
  const model = document.getElementById('cfg_pol_model').value || 'openai';
  const seed  = document.getElementById('cfg_pol_seed').value || '';
  const prompt = buildPrompt();
  const struct = buildStructureForAI();

  // Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§ Ø£Ùˆ Ù…Ù† config
  const API_KEY = document.getElementById('cfg_pol_key')?.value || 'sk_MaTlSFUyKRob2VijGwZNKuI35DTWbRl5';

  onProgress(15,'Pollinations â€” Ø¥Ø±Ø³Ø§Ù„...');

  // Build clean base64 data URL
  const imgUrl = b64.startsWith('data:') ? b64 : `data:image/jpeg;base64,${b64}`;

  const body = {
    model,
    messages:[{
      role:'user',
      content:[
        {
          type:'text',
          text:`${prompt}\n\nØ£Ø¹Ø¯ JSON ÙÙ‚Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¢Ø®Ø±:\n${struct}`
        },
        {
          type:'image_url',
          image_url:{ url: imgUrl }
        }
      ]
    }],
    max_tokens:2000,
    temperature:0.3,
    ...(seed ? {seed:parseInt(seed)} : {})
  };

  const response = await fetch('https://gen.pollinations.ai/v1/chat/completions', {
    method:'POST',
    headers:{
      'Authorization': `Bearer ${API_KEY}`,
      'Content-Type':'application/json'
    },
    body:JSON.stringify(body)
  });

  onProgress(80,'Pollinations â€” Ù…Ø¹Ø§Ù„Ø¬Ø©...');

  if(!response.ok){
    let msg=`HTTP ${response.status}`;
    try{
      const e=await response.json();
      msg=e.error?.message || JSON.stringify(e);
    }catch(ex){}
    throw new Error(`Pollinations: ${msg}`);
  }

  const data = await response.json();

  // Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ OpenAI Ø§Ù„Ø¬Ø¯ÙŠØ¯
  const text = data.choices?.[0]?.message?.content || '';
  if(!text) throw new Error('Pollinations: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø±Ø¯');

  return extractJSON(text);
}

// â”€â”€ 2. OPENROUTER (Free models available) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callOpenRouter(b64, onProgress){
  const model=document.getElementById('cfg_or_model').value;
  const key=getKey('openrouter');
  const prompt=buildPrompt();
  const struct=buildStructureForAI();

  onProgress(20,'OpenRouter â€” Ø¥Ø±Ø³Ø§Ù„...');

  const headers={'Content-Type':'application/json','HTTP-Referer':'https://famelo.ai','X-Title':'Famelo v8'};
  if(key) headers['Authorization']=`Bearer ${key}`;

  const response=await fetch('https://openrouter.ai/api/v1/chat/completions',{
    method:'POST',headers,
    body:JSON.stringify({
      model,
      messages:[{role:'user',content:[
        {type:'text',text:`${prompt}\n\nØ£Ø¹Ø¯ JSON ÙÙ‚Ø·:\n${struct}`},
        {type:'image_url',image_url:{url:b64}}
      ]}],
      max_tokens:2000,temperature:0.3
    })
  });

  onProgress(80,'OpenRouter â€” Ù…Ø¹Ø§Ù„Ø¬Ø©...');
  if(!response.ok){let e=`HTTP ${response.status}`;try{const r=await response.json();e=r.error?.message||JSON.stringify(r);}catch(ex){}throw new Error('OpenRouter: '+e);}
  const data=await response.json();
  return extractJSON(data.choices?.[0]?.message?.content||'');
}

// â”€â”€ 3. GEMINI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callGemini(b64, onProgress){
  const key=getKey('gemini');
  if(!key) throw new Error('Ù…ÙØªØ§Ø­ Gemini API Ù…Ø·Ù„ÙˆØ¨');
  const model=document.getElementById('cfg_gem_model').value;
  const prompt=buildPrompt();
  const struct=buildStructureForAI();

  return new Promise((resolve,reject)=>{
    const xhr=new XMLHttpRequest();
    xhr.open('POST',`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`);
    xhr.setRequestHeader('Content-Type','application/json');
    xhr.upload.onprogress=e=>{if(e.lengthComputable)onProgress(e.loaded/e.total*50,'Gemini â€” Ø±ÙØ¹...');};
    xhr.onloadstart=()=>onProgress(55,'Gemini â€” ØªØ­Ù„ÙŠÙ„...');
    xhr.onload=()=>{
      if(xhr.status>=200&&xhr.status<300){
        try{
          const res=JSON.parse(xhr.responseText);
          if(res.error) throw new Error(res.error.message);
          resolve(extractJSON(res.candidates[0].content.parts[0].text));
        }catch(e){reject(new Error('Gemini parse: '+e.message));}
      }else{
        let msg=`HTTP ${xhr.status}`;
        try{const r=JSON.parse(xhr.responseText);msg=r.error?.message||msg;}catch(ex){}
        reject(new Error('Gemini: '+msg));
      }
    };
    xhr.onerror=()=>reject(new Error('Gemini: Ø®Ø·Ø£ Ø´Ø¨ÙƒØ©'));
    xhr.send(JSON.stringify({contents:[{parts:[
      {text:`${prompt}\n\nØ£Ø¹Ø¯ JSON ÙÙ‚Ø·:\n${struct}`},
      {inline_data:{mime_type:'image/jpeg',data:b64.split(',')[1]}}
    ]}]}));
  });
}

// â”€â”€ 4. GROQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callGroq(b64, onProgress){
  const key=getKey('groq');
  if(!key) throw new Error('Ù…ÙØªØ§Ø­ Groq API Ù…Ø·Ù„ÙˆØ¨');
  const model=document.getElementById('cfg_groq_model').value;
  const prompt=buildPrompt();
  const struct=buildStructureForAI();

  onProgress(25,'Groq â€” Ø¥Ø±Ø³Ø§Ù„...');
  const res=await fetch('https://api.groq.com/openai/v1/chat/completions',{
    method:'POST',
    headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},
    body:JSON.stringify({model,messages:[{role:'user',content:[
      {type:'text',text:`${prompt}\n\nØ£Ø¹Ø¯ JSON ÙÙ‚Ø·:\n${struct}`},
      {type:'image_url',image_url:{url:b64}}
    ]}],max_tokens:2000,temperature:0.3})
  });
  onProgress(80,'Groq â€” Ù…Ø¹Ø§Ù„Ø¬Ø©...');
  if(!res.ok){const e=await res.text();throw new Error('Groq: '+e);}
  const data=await res.json();
  return extractJSON(data.choices[0].message.content);
}

// â”€â”€ 5. HUGGINGFACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callHuggingFace(b64, onProgress){
  const key=getKey('huggingface');
  if(!key) throw new Error('Ù…ÙØªØ§Ø­ HuggingFace API Ù…Ø·Ù„ÙˆØ¨');
  const model=document.getElementById('cfg_hf_model').value;
  const prompt=buildPrompt();
  const struct=buildStructureForAI();
  onProgress(20,'HuggingFace â€” Ø¥Ø±Ø³Ø§Ù„...');
  const cleanB64=b64.startsWith('data:') ? b64 : `data:image/jpeg;base64,${b64}`;
  const res=await fetch(`https://api-inference.huggingface.co/models/${model}/v1/chat/completions`,{
    method:'POST',
    headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},
    body:JSON.stringify({model,messages:[{role:'user',content:[
      {type:'text',text:`${prompt}\n\nØ£Ø¬Ø¨ Ø¨Ù€ JSON ÙÙ‚Ø·:\n${struct}`},
      {type:'image_url',image_url:{url:cleanB64}}
    ]}],max_tokens:2000})
  });
  onProgress(80,'HuggingFace â€” Ù…Ø¹Ø§Ù„Ø¬Ø©...');
  if(!res.ok){
    const ed=await res.json();
    const em=ed.error||JSON.stringify(ed);
    if(em.includes('loading')) throw new Error('Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠÙØ­Ù…ÙÙ‘Ù„ â€” Ø§Ù†ØªØ¸Ø± 30 Ø«Ø§Ù†ÙŠØ© ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
    throw new Error('HuggingFace: '+em);
  }
  const data=await res.json();
  return extractJSON(data.choices?.[0]?.message?.content||'');
}

// â”€â”€ 6. TOGETHER AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callTogether(b64, onProgress){
  const key=getKey('together');
  if(!key) throw new Error('Ù…ÙØªØ§Ø­ Together AI Ù…Ø·Ù„ÙˆØ¨');
  const model=document.getElementById('cfg_tog_model').value;
  const prompt=buildPrompt();
  const struct=buildStructureForAI();
  onProgress(25,'Together â€” Ø¥Ø±Ø³Ø§Ù„...');
  const res=await fetch('https://api.together.xyz/v1/chat/completions',{
    method:'POST',
    headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},
    body:JSON.stringify({model,messages:[{role:'user',content:[
      {type:'text',text:`${prompt}\n\nØ£Ø¹Ø¯ JSON ÙÙ‚Ø·:\n${struct}`},
      {type:'image_url',image_url:{url:b64}}
    ]}],max_tokens:2000,temperature:0.3})
  });
  onProgress(80,'Together â€” Ù…Ø¹Ø§Ù„Ø¬Ø©...');
  if(!res.ok){const e=await res.text();throw new Error('Together: '+e);}
  const data=await res.json();
  return extractJSON(data.choices[0].message.content);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESULTS & EXPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetails(id){
  const item=filesData.find(f=>f.id===id);
  if(!item?.result) return;
  let html=`<div style="text-align:center;padding:16px;background:var(--card2);border-radius:10px;margin-bottom:20px;"><img src="${URL.createObjectURL(item.file)}" style="max-height:220px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,.5);"><div style="margin-top:10px;font-weight:700;font-size:.9rem;">${item.file.name}</div></div><table style="width:100%;border-collapse:collapse;">`;
  for(const[k,v] of Object.entries(item.result)){
    html+=`<tr style="border-bottom:1px solid var(--border);"><td style="padding:12px 14px;font-weight:600;color:var(--text2);font-size:.78rem;width:35%;">${k}</td><td style="padding:12px 14px;"><div style="display:flex;align-items:center;gap:10px;justify-content:space-between;"><span style="word-break:break-word;flex:1;font-size:.82rem;">${v}</span><button onclick="copyVal('${String(v).replace(/'/g,"\\'")}',this)" style="background:var(--card3);border:1px solid var(--border);color:var(--text2);padding:5px 10px;border-radius:6px;cursor:pointer;font-size:.68rem;white-space:nowrap;font-family:inherit;font-weight:600;"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button></div></td></tr>`;
  }
  html+='</table>';
  document.getElementById('modalBody').innerHTML=html;
  document.getElementById('modal').style.display='flex';
}

function copyVal(text,btn){
  navigator.clipboard.writeText(text).then(()=>{
    const orig=btn.innerHTML; btn.innerHTML='<i class="fas fa-check"></i> ØªÙ…!';
    btn.style.background='var(--green)'; btn.style.color='#000';
    setTimeout(()=>{btn.innerHTML=orig;btn.style.background='';btn.style.color='';},1800);
  });
}

function generateAndDownload(){
  if(!globalResults.length){showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬','','warning');return;}
  const type=document.getElementById('final_type').value;
  const name=document.getElementById('final_name').value;
  try{
    if(type==='xlsx'){
      const ws=XLSX.utils.json_to_sheet(globalResults);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'Famelo_Data');
      XLSX.writeFile(wb,`${name}.xlsx`);
    }else if(type==='csv'){
      const keys=Object.keys(globalResults[0]);
      let csv='\uFEFF'+keys.join(',')+'\n';
      globalResults.forEach(row=>{csv+=keys.map(k=>`"${String(row[k]||'').replace(/"/g,'""')}"`).join(',')+'\n';});
      dlBlob(csv,'text/csv',`${name}.csv`);
    }else{
      dlBlob(JSON.stringify(globalResults,null,2),'application/json',`${name}.json`);
    }
    log(`ØªÙ… ØªØ­Ù…ÙŠÙ„: ${name}.${type}`,'success');
    showNotification('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±',`${name}.${type}`,'success');
  }catch(e){showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±',e.message,'error');}
}

function dlBlob(content,mime,filename){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type:mime}));
  a.download=filename; a.click(); URL.revokeObjectURL(a.href);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.overlay-bg').classList.toggle('open');
}
</script>
</body>
</html>
